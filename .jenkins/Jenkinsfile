pipeline {
  agent any
  environment {
    IMAGE_NAME = "globe-app"
    CONTAINER_NAME = "globe-running"
    BACKUP_IMAGE = "globe-app:backup"
    COMPOSE_FILE = "docker-compose.yml"
  }
  stages {
    stage('Clone Repository') {
      steps {
        git branch: 'master', url: 'https://github.com/Bharath-Bhandaru/restapi-proj.git'
      }
    }
    
    stage('Backup Current Deployment') {
      steps {
        script {
          sh "docker tag $IMAGE_NAME $BACKUP_IMAGE || true"
          sh "docker-compose -f $COMPOSE_FILE down || true"
        }
      }
    }
    
    stage('Build and Test') {
      steps {
        sh 'docker-compose -f $COMPOSE_FILE build'
      }
    }
    
    stage('Deploy') {
      steps {
        sh """
          docker-compose -f $COMPOSE_FILE up -d
        """
      }
    }
  }
  post {
    success {
      echo "✅ Deployment successful!"
      archiveArtifacts artifacts: '*/.log', allowEmptyArchive: true
    }
    failure {
      echo "❌ Build or deployment failed. Rolling back..."
      script {
        sh "docker-compose -f $COMPOSE_FILE down || true"
        sh """
          docker run -d \
          --name $CONTAINER_NAME \
          -p 5000:5000 \
          $BACKUP_IMAGE || true
        """
      }
    }
  }
}